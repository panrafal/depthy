"use strict";angular.module("depthyApp",["ngAnimate","ngTouch","ga","shareUrls","ui.router","ui.bootstrap.buttons","ui.bootstrap.modal","ui.bootstrap.transition","ui.bootstrap.dropdown"]).config(["$compileProvider",function(a){a.imgSrcSanitizationWhitelist(/^\s*(https?|blob):|data:image\//),a.aHrefSanitizationWhitelist(/^\s*(https?|blob):/)}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b,c){c.html5Mode(!1),b.otherwise("/"),a.state("index",{url:"/",onEnter:["depthy","$state",function(a,b){b.current.name||(a.leftpaneOpen(),a.loadSampleImage("flowers"))}]}).state("sample",{url:"/sample/:id",controller:["$stateParams","depthy",function(a,b){b.loadSampleImage(a.id)}]}).state("imgur",{url:"/ip/:id",controller:["$stateParams","$state","depthy",function(a,b,c){c.loadUrlDirectImage("http://i.imgur.com/"+a.id+".png",!0,{state:"imgur",stateParams:{id:a.id},thumb:"http://i.imgur.com/"+a.id+"s.jpg",storeUrl:"http://imgur.com/"+a.id,store:c.stores.imgur})}]}).state("imgur2",{url:"/ii/:id",controller:["$stateParams","depthy",function(a,b){b.loadUrlImage("http://i.imgur.com/"+a.id+".png",{state:"imgur2",stateParams:{id:a.id},thumb:"http://i.imgur.com/"+a.id+"m.jpg",storeUrl:"http://imgur.com/"+a.id,store:b.stores.imgur})}]}).state("url-png",{url:"/up?url",controller:["$stateParams","$state","depthy",function(a,b,c){c.loadUrlDirectImage(a.url,!0,{state:"url-png",stateParams:{url:a.url}})}]}).state("url-auto",{url:"/u?url",controller:["$stateParams","$state","depthy",function(a,b,c){c.loadUrlImage(a.url,{state:"url-auto",stateParams:{url:a.url}})}]}).state("local",{url:"/local/:id",hollow:!0,controller:["$stateParams","depthy",function(a,b){b.loadLocalImage(a.id)}]}).state("alert",{url:"/alert"}).state("image",{url:"/image"}).state("image.options",{url:"/options"}).state("image.info",{url:"/info"}).state("export",{url:"/export"}).state("export.png",{url:"/png"}).state("export.gif",{url:"/gif"}).state("export.gif.options",{url:"/options"}).state("export.gif.run",{url:"/run"}).state("share",{url:"/share"}).state("share.options",{url:"/options"}).state("share.png",{url:"/png"}).state("pane",{url:"/pane",hollow:!0,onEnter:["depthy",function(a){a.leftpaneOpen()}]}).state("howto",{url:"/howto"}).state("howto.lensblur",{url:"/lensblur",onEnter:["StateModal",function(a){a.showModal("howto.lensblur",{stateCurrent:!0,templateUrl:"views/howto-lensblur.html"})}]})}]).run(["$rootScope","ga","$location","$state",function(a,b,c,d){var e=a.$on("$stateChangeStart",function(a,b,c,f){e(),console.log(a,b,c,f),!b.hollow&&(b.controller||b.onEnter||b.template||b.templateUrl)||(console.warn("Hollow state %s",b.name),a.preventDefault(),d.go("index"))});a.$on("$stateChangeSuccess",function(){b("set","page",c.url()),b("send","pageview")})}]),angular.module("depthyApp").provider("depthy",function(){var a=angular.extend({},DepthyViewer.defaultOptions,{hoverElement:"body",fit:Modernizr.mobile?"cover":"contain",depthScale:Modernizr.mobile?2:1});this.$get=["ga","$timeout","$rootScope","$document","$window","$q","$modal","$state","StateModal","UpdateCheck",function(b,c,d,e,f,g,h,i,j,k){function l(a){return a&&a.isShareable&&a.isStoreable}function m(a){var b=angular.extend({imageSource:null,depthSource:null,depthUsesAlpha:!1,originalSource:null,state:null,stateParams:null,loading:!1,url:void 0,local:void 0,parsed:void 0,sample:void 0,title:!1,thumb:!1,store:!1,storeUrl:!1,storeKey:!1,added:!1,viewed:!1,views:0,sharedAs:null,isShareable:function(){return b.state&&!b.local},isShared:function(){return!!b.storeKey},isStoreable:function(){return!!(b.isShareable()&&b.isConfirmed()&&b.thumb&&b.thumb.length<500)},isEmpty:function(){return!(b.url||b.local||b.sample||b.procesing)||b.empty},isOpened:function(){return x.opened===b},isConfirmed:function(){return b.viewed||b.sample||b.isShared()&&b.thumb},isLocal:function(){return!!b.local},isSample:function(){return!!b.sample},isRemote:function(){return!!b.url},isModified:function(){return!!b.modified},isAvailable:function(){return!x.isOffline()||this.isSample()||this.isLocal()},getType:function(){return b.isLocal()?"local":b.isModified()?"modified":b.isShared()?"shared":b.isSample()?"sample":b.isRemote()?"remote":"unknown"},getFilename:function(){return b.title||b.stateParams&&b.stateParams.id||"image"},getStateUrl:function(){return b.state?i.href(b.state,b.stateParams||{}):!1},openState:function(){if(!b.state)throw"No state to go to";i.go(b.state,b.stateParams)},getShareUrl:function(a){return b.sharedAs&&a!==!1?b.sharedAs.getShareUrl(!1):b.isShareable()?x.rootShareUrl+b.getStateUrl():!1},getShareInfo:function(a){if(b.sharedAs&&a!==!1)return b.sharedAs.getShareInfo(!1);var c=b.getShareUrl(!1);return c?{url:c,title:(b.title?b.title+" ":"")+"#depthy",img:b.thumb&&(b.thumb.match(/^https?:/)?b.thumb:x.rootShareUrl+b.thumb)}:null},getShareImage:function(){return b.sharedAs||b},createShareImage:function(a){a=angular.extend({sharedFrom:b,title:b.title,thumb:b.thumb},a);var c=n(a,!0);return b.sharedAs=c,z(),q(),c},markAsModified:function(){b.sharedAs=null,b.modified=!0},onOpened:function(){b.loading=!1,b._checkIfReady()},onDepthmapOpened:function(){b.loading=!1,b._checkIfReady()},_checkIfReady:function(){return b.state&&b.isOpened()&&x.isReady()&&x.hasDepthmap()?void this.onViewed():!1},onViewed:function(){b.thumb||x.getViewer().exportThumbnail({width:75,height:75},.8).then(function(a){b.thumb=a,console.log("Thumbnail generated %db",a.length),d.$safeApply()}),b.viewed=(new Date).getTime(),b.views+=1,q(),z(),d.$safeApply()},onClosed:function(){b.sample||b.isModified()||(b.imageSource=b.depthSource=b.originalSource=b.depthUsesAlpha=!1),b.loading=!1},addToHistory:function(){y.indexOf(b)<0&&(b.added===!1&&(b.added=(new Date).getTime()),y.push(b))},removeFromHistory:function(){_.remove(y,function(a){return a===b})},tryToReopen:function(){return b.isOpened()?x.getReadyPromise():b.imageSource?(console.log("%cReopening image: %o","font-weight: bold",b),p(b),x.getViewer().setDepthmap(b.depthSource,b.depthUsesAlpha),x.refreshOpenedImage().finally(b.onOpened)):!1}},a||{});return b}function n(a,b){var c;return l(a)?a:(a.state&&(a.state===!0&&(a.state=i.current.name,a.stateParams=i.params),c=_.find(y,{state:a.state,stateParams:a.stateParams})),c?_["extend"===b?"extend":"defaults"](c,a):b&&(c=m(a),c.state&&c.addToHistory()),c)}function o(a,b){b&&(a=angular.extend(a,b));var c=n(a,"extend");return c}function p(a){return a.isOpened()?a:(x.opened&&(x.opened.onClosed(),x.getViewer().reset()),a.loading=!0,x.opened=a,x.opened)}function q(){console.log("updateImageGallery");var a=_.filter(y,function(a){return a.isConfirmed()});a.sort(function(a,b){return a.added===b.added?0:a.added>b.added?-1:1}),x.gallery=a}function r(){if(x.samples.forEach(function(a){n({state:"sample",stateParams:{id:a.id},sample:a.id,title:a.title,thumb:"samples/"+a.id+"-thumb.jpg",imageSource:"samples/"+a.id+"-image.jpg",depthSource:"samples/"+a.id+"-depth.jpg",originalSource:"samples/"+a.id+"-alternative.jpg",added:0},!0)}),Modernizr.localstorage){var a=JSON.parse(localStorage.getItem("history")||"null");angular.isObject(a)&&(console.log("restoreImageHistory",a),a.forEach(function(a){a=n(a,"sample"===a.state?!1:"default"),a&&!a.isStoreable()&&a.removeFromHistory()}))}}function s(){if(Modernizr.localstorage){var a=JSON.parse(localStorage.getItem("settings")||"null");angular.isObject(a)&&(_.merge(x,_.pick(a,B)),_.merge(x.viewer,_.pick(a.viewer,A)),a.version!==x.version&&t(a.version),console.log("restoreSettings",a))}}function t(a){console.log("New version %s -> %s",a,x.version),C()}function u(){k.check(x.storedDate&&(new Date).getTime()-x.storedDate>864e5).then(function(a){a&&(x.gotUpdate=!0),C()})}function v(){d.$on("$stateChangeSuccess",function(){x.zenMode=!1}),p(m({empty:!0})),s(),u(),r(),q(),d.$watch(function(){var b=_.pick(x,B);return b.viewer=_.pick(a,A),b},function(a,b){a!==b&&C()},!0)}var w,x,y=[],z=_.throttle(function(){if(Modernizr.localstorage){var a=y.filter(function(a){return a.isStoreable()}).map(function(a){return _.pick(a,["state","stateParams","title","url","thumb","added","viewed","views","storeKey"])});console.log("storeImageHistory",y,a),window.localStorage.setItem("history",JSON.stringify(a))}},4e3,{leading:!1}),A=["fit","animate","animateDuration","animatePosition","animateScale","depthScale","depthFocus","tipsState"],B=["useOriginalImage","exportSize","storedDate"],C=_.throttle(function(){if(Modernizr.localstorage&&!x.isViewerOverriden()){x.storedDate=(new Date).getTime();var b=_.pick(x,B);b.viewer=_.pick(a,A),b.version=x.version,console.log("storeSettings",b),window.localStorage.setItem("settings",JSON.stringify(b))}},4e3,{leading:!1});return x={viewer:a,version:203,tipsState:{},lastSettingsDate:null,exportSize:Modernizr.mobile?150:300,exportType:"gif",imgurId:"b4ca5b16efb904b",rootShareUrl:"http://depthy.me/",share:{url:"http://depthy.me/"},leftpaneOpened:!1,activePopup:null,movearoundShow:!1,zenMode:!1,opened:null,useOriginalImage:!1,modalWait:700,gallery:[],samples:[{id:"flowers",title:"Flowers"},{id:"hut",title:"Hut"},{id:"shelf",title:"Shelf"},{id:"mango",title:"Mango"},{id:"tunnel",title:"Tunnel"}],stores:{imgur:{name:"imgur"}},downloadInstructions:Modernizr.adownload?"Click the image":Modernizr.mobile?"Touch and hold the image":"Right-click the image",getVersion:function(){return Math.floor(this.version/1e4)+"."+Math.floor(this.version%1e4/100)+"."+this.version%100},isReady:function(){return this.getViewer().isReady()},isLoading:function(){return!!this.opened.loading&&Modernizr.webgl},hasImage:function(){return this.getViewer().hasImage()},hasDepthmap:function(){return this.getViewer().hasDepthmap()},hasOriginalImage:function(){return!!this.opened.originalSource},hasCompleteImage:function(){return this.hasImage()&&this.hasDepthmap()},getLoadError:function(){return this.opened.error},isFullLayout:function(){return f.innerWidth>=1200},isOffline:function(){return navigator.onLine===!1},isViewerOverriden:function(a){return void 0!==a&&(x.viewerOverriden=a),x.viewerOverriden||x.exportActive},getViewerCtrl:function(){return this._viewerCtrl||(this._viewerCtrl=angular.element("[depthy-viewer]").controller("depthyViewer")),this._viewerCtrl},getViewer:function(){return this._viewer||(this._viewer=this.getViewerCtrl().getViewer()),this._viewer},storeSettings:C,refreshOpenedImage:function(){var a=this.opened;return this.getViewer().setImage((x.useOriginalImage?a.originalSource:a.imageSource)||a.imageSource),this.getReadyPromise()},getReadyPromise:function(){return g.when(x.getViewer().getPromise())},loadImage:function(a){var b=o(a);return b.tryToReopen()?this.getReadyPromise():g.reject("Image can't be loaded!")},loadSampleImage:function(a){return this.loadImage({state:"sample",stateParams:{id:a}})},_fileId:0,loadLocalImage:function(a){var b=_.isObject(a)?++this._fileId+"":a,c=o({state:"local",stateParams:{id:b},local:!0,parsed:!0});if(c.tryToReopen())return this.getReadyPromise();p(c),_.isObject(a)?(c.title=(a.name||"").replace(/\.(jpe?g|png)$/i,""),c.imageFile=a):(a=c.imageFile,console.log("Reopening old file",a));var d=g.defer();if(a)if(a.type&&"image/jpeg"!==a.type&&"image/png"!==a.type)d.reject("Only JPEG and PNG, please!");else{var e=new FileReader;e.onload=function(){d.resolve(e.result)},e.readAsArrayBuffer(a)}else d.reject("Can't open this image anymore");return d.promise.then(function(a){return x._loadFromArrayBuffer(a,c)}).catch(function(a){c.error=a}).finally(c.onOpened)},loadUrlImage:function(a,b){var c=o({url:a,parsed:!0},b);if(c.tryToReopen())return this.getReadyPromise();p(c);var d=new XMLHttpRequest,e=g.defer();return d.open("get",a),d.responseType="arraybuffer",d.onload=function(){e.resolve(this.response)},d.onerror=function(){e.reject()},d.send(null),e.promise.then(function(a){return x._loadFromArrayBuffer(a,c)}).catch(function(a){c.error=angular.isString(a)?a:"Image not found!"}).finally(c.onOpened)},loadUrlDirectImage:function(a,b,c){var d=o({url:a,imageSource:a,depthSource:b?a:!1,depthUsesAlpha:b},c);return d.tryToReopen()?this.getReadyPromise():(p(d),this.getViewer().setDepthmap(d.depthSource,b),x.refreshOpenedImage().catch(function(a){d.error=angular.isString(a)?a:"Image not found!"}).finally(d.onOpened))},_loadFromArrayBuffer:function(a,b){var c=new Uint8Array(a);if(isJpg(c)){var d=new DepthReader,e=g.defer(),f=function(c){console.log("DepthExtractor result",c),b.imageSource=URL.createObjectURL(new Blob([a],{type:"image/jpeg"})),b.depthSource=d.depth.data?"data:"+d.depth.mime+";base64,"+d.depth.data:!1,b.originalSource=d.image.data?"data:"+d.image.mime+";base64,"+d.image.data:!1,x.getViewer().setDepthmap(b.depthSource),e.resolve(x.refreshOpenedImage())};return d.parseFile(a,f,f),e.promise}if(isPng(c)){var h=c[24],i=c[25],j=4===i||6===i,k=URL.createObjectURL(new Blob([a],{type:"image/jpeg"}));return console.log("PNG depth %d colorType %d transparent %s",h,i,j),b.imageSource=k,b.depthSource=j?k:!1,b.depthUsesAlpha=j,b.originalSource=!1,x.getViewer().setDepthmap(b.depthSource,j),x.refreshOpenedImage()}g.reject("Only JPEG and PNG, please!")},loadLocalDepthmap:function(a){var b=new FileReader,c=g.defer(),d=x.opened;return"image/jpeg"===a.type?(b.onload=function(){var a=b.result,e=new Uint8Array(a);if(isJpg(e)){var f=new DepthReader;d.loading=!0;var g=function(){d.depthSource=f.depth.data?"data:"+f.depth.mime+";base64,"+f.depth.data:URL.createObjectURL(new Blob([a],{type:"image/jpeg"})),d.depthUsesAlpha=!1,x.getViewer().setDepthmap(d.depthSource),c.resolve(x.getViewer().getPromise()),c.promise.finally(d.onDepthmapOpened)};f.parseFile(a,g,g)}},b.readAsArrayBuffer(a)):"image/png"===a.type?(d.loading=!0,d.depthSource=URL.createObjectURL(a),d.depthUsesAlpha=!1,x.getViewer().setDepthmap(d.depthSource),c.resolve(x.getViewer().getPromise()),c.promise.finally(d.onDepthmapOpened)):c.reject("Only JPEG and PNG files are supported!"),c.promise.finally(function(){d.markAsModified()}),c.promise},exportAnimation:function(){var b,c=g.defer(),e=c.promise;return Modernizr.load({test:window.GIF,nope:"bower_components/gif.js/dist/gif.js",complete:function(){var f={width:x.exportSize,height:x.exportSize},g=a.animateDuration,h=Math.min(25,Math.max(8,a.depthScale*(300>f?.5:1)*15/g)),i=Math.max(4,Math.round(g*h)),j=Math.round(1e3*g/i),k=x.getViewer(),l=k.getOptions();b=new GIF({workers:2,quality:10,workerScript:"bower_components/gif.js/dist/gif.worker.js"}),console.log("FPS %d Frames %d Delay %d Scale %d Size %d Duration %d",h,i,j,a.depthScale,x.exportSize,g);for(var m=0;i>m;++m)k.setOptions({size:f,animate:!0,fit:!1,animatePosition:m/i}),k.render(!0),b.addFrame(k.getCanvas(),{copy:!0,delay:j});b.on("progress",function(a){c.notify(a)}),b.on("abort",function(){e.abort=function(){},c.reject()}),b.on("finished",function(a){e.abort=function(){},c.resolve(a),x.viewer.overrideStageSize=null,d.$safeApply()}),e.finally(function(){k.setOptions(l)}),b.render()}}),e.abort=function(){b.abort()},e},dataURItoBlob:function(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):window.unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:c})},isLeftpaneOpened:function(){return this.leftpaneOpened||this.isFullLayout()},leftpaneToggle:function(){x.leftpaneOpened?x.leftpaneClose():x.leftpaneOpen()},leftpaneOpen:function(a){a=!1,x.zenMode=!1,this.isFullLayout()||(a||x.leftpaneOpen===!0||w||(x.activePopup&&x.activePopup.reject(),w=j.stateDeferred(!0),w.promise.finally(function(){x.leftpaneOpened===!0&&(x.leftpaneOpened=!1),w=null})),x.leftpaneOpened=a?"gallery":!0)},leftpaneClose:function(){this.isFullLayout()||(w&&(x.leftpaneOpened===!0&&w.reject(),w=null),x.leftpaneOpened=!1)},openPopup:function(a,b){return x.leftpaneClose(),x.activePopup=j.stateDeferred(!0,b),x.activePopup.state=a,x.activePopup.promise.finally(function(){x.activePopup.state===a&&(x.activePopup=null)}),x.activePopup},zenModeToggle:function(){return"gallery"!==x.leftpaneOpened&&x.leftpaneClose(),x.isReady()&&x.hasCompleteImage()?void(x.zenMode=!x.zenMode):void(x.zenMode=!1)},reload:function(){f.location.reload()}},v(),x}]}),angular.module("depthyApp").controller("MainCtrl",["$rootScope","$window","$scope","$timeout","ga","depthy","$element","$modal","$state","StateModal",function(a,b,c,d,e,f,g,h,i,j){a.depthy=f,a.viewer=f.viewer,a.Modernizr=window.Modernizr,a.screenfull=screenfull,c.version=f.getVersion(),e("set","dimension1",(Modernizr.webgl?"webgl":"no-webgl")+" "+(Modernizr.webp?"webp":"no-webp")),a.$safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)},c.loadSample=function(a){i.go("sample",{id:a})},c.openImage=function(a){i.go(a.state,a.stateParams)},c.animateOption=function(a,b,d){$(a).animate(b,{duration:d||250,step:function(){c.$safeApply()},complete:function(){_.extend(a,b),c.$safeApply()}})},c.$watch("compoundFiles",function(a){a&&a.length&&f.loadLocalImage(a[0]).then(function(){e("send","event","image","parsed",f.hasDepthmap()?"depthmap":"no-depthmap"),f.leftpaneClose(),f.opened.openState()},function(a){e("send","event","image","error",a),f.leftpaneClose()})}),c.$watch("depthy.useOriginalImage",function(){f.refreshOpenedImage()}),c.imageOptions=function(){f.openPopup("image.options")},c.shareOptions=function(){f.openPopup("share.options")},c.imageInfo=function(){j.showModal("image.info",{templateUrl:"views/image-info-modal.html",windowClass:"info-modal",controller:"ImageInfoModalCtrl"})},c.exportGifOptions=function(){var a=f.viewer.animate;f.viewer.animate=!0,f.openPopup("export.gif.options").promise.finally(function(){f.viewer.animate=a})},c.exportGifRun=function(){f.exportActive=!0,j.showModal("export.gif.run",{templateUrl:"views/export-modal.html",controller:"ExportModalCtrl",keyboard:!1,windowClass:"export-modal"}).result.finally(function(){f.exportActive=!1})},c.exportPngRun=function(){j.showModal("export.png",{templateUrl:"views/export-png-modal.html",controller:"ExportPngModalCtrl",windowClass:"export-png-modal"}).result.finally(function(){})},c.sharePngRun=function(){j.showModal("share.png",{templateUrl:"views/share-png-modal.html",controller:"SharePngModalCtrl",windowClass:"share-png-modal"}).result.finally(function(){})},c.$watch('(depthy.activePopup.state === "export.gif.options" || depthy.exportActive) && depthy.exportSize',function(a){a?(f.isViewerOverriden(!0),f.viewer.size={width:a,height:a},c.oldFit=f.viewer.fit,f.viewer.fit=!1):(c.oldFit&&(f.viewer.fit=c.oldFit),$(b).resize(),f.isViewerOverriden(!1))}),c.$watch("viewer.fit",function(a){"cover"===a?f.viewer.upscale=4:"contain"===a&&(f.viewer.upscale=1)}),c.$on("pixi.webgl.init.exception",function(a,b){console.error("WebGL Init Exception",b),Modernizr.webgl=!1,e("send","event","webgl","exception",b.toString(),{nonInteraction:1})}),$(b).on("resize",function(){f.viewer.size={width:b.innerWidth,height:b.innerHeight},c.$safeApply()}),$(b).resize(),$(b).on("online offline",function(){c.$safeApply()}),d(function(){c.scroll=new IScroll("#leftpane",{mouseWheel:!0,scrollbars:"custom",click:!1,fadeScrollbars:!0,interactiveScrollbars:!0,resizeScrollbars:!1,eventPassthrough:"horizontal"}),c.$watch(function(){setTimeout(function(){console.log("scroll refresh"),c.scroll.refresh()},100)})})}]),angular.module("depthyApp").directive("fileselect",["$parse",function(a){return{restrict:"A",scope:!0,link:function(b,c,d){function e(c){b.$broadcast("fileselect",c),d.fileselect&&a(d.fileselect).assign(b,c)}var f=document.createElement("input");f.type="file",f.style.visibility="hidden",f.style.position="absolute",f.style.left="-9000px",c.append(f);var g=function(a){a.stopPropagation(),a.preventDefault()},h=function(a){a.stopPropagation(),a.preventDefault(),console.log(a);var c=a.originalEvent.dataTransfer,d=c.files;e(d),b.$apply()};b.selectFile=function(a){f.click(),a&&a.preventDefault()},c.on("dragenter",g),c.on("dragover",g),c.on("drop",h),f.addEventListener("change",function(){e(_.filter(this.files)),f.value="",b.$apply()},!1)}}}]),angular.module("depthyApp").directive("pixi",["$parse",function(a){return{restrict:"A",scope:!1,controller:["$scope","$element","$attrs",function(b,c,d){function e(){f.render(),requestAnimFrame(e)}var f=this,g=a(d.pixi),h=g(b),i=b.$eval(d.pixiRender);h||(h=new PIXI.Stage(b.$eval(d.pixiBackground||"0")),g.assign(b,h));var j,k=b.$eval(d.pixiAntialias||"false"),l=b.$eval(d.pixiTransparent||"false"),m=b.$eval(d.pixiRenderer||"auto");switch(m){case"canvas":j=new PIXI.CanvasRenderer(c.width(),c.height(),c[0],l);break;case"webgl":try{j=new PIXI.WebGLRenderer(c.width(),c.height(),c[0],l,k)}catch(n){return void b.$emit("pixi.webgl.init.exception",n)}break;default:j=PIXI.autoDetectRenderer(c.width(),c.height(),c[0],k,l)}this.render=function(a){var b=!0;i&&(b=i(h,j)),(a||b!==!1)&&j.render(h)},requestAnimFrame(e),this.getStage=function(){return h},this.getRenderer=function(){return j},this.getContext=function(){return j.gl?j.gl:j.context}}]}}]),angular.module("depthyApp").directive("depthyViewer",function(){return{restrict:"A",scope:!0,controller:["$scope","$element","$attrs",function(a,b,c){var d,e=a.$parent.$eval(c.depthyViewer);a.$parent.$watch(c.depthyViewer,function(a){d&&a&&d.setOptions(e)},!0),d=new DepthyViewer(b[0],e),this.getViewer=function(){return d}}]}}),angular.module("shareUrls",[]).provider("ShareUrls",function(){function a(a,c){var d,e,f;for(d in c)e="{"+d+"}",-1!==a.indexOf(e)&&(a=a.replace(new RegExp(e,"g"),encodeURIComponent(c[d]))),f="{"+d+"-ne}",-1!==a.indexOf(f)&&(a=a.replace(new RegExp(f,"g"),c[d]));return b(a)}function b(a){a=a.replace(/\{([^{}]*)}/g,"");var b=a.match(/[^\=\&\?]+=[^\=\&\?]+/g),c=a.split("?")[0];return b&&b.length>0&&(c+="?"+b.join("&")),c}var c=this,d={facebook:{url:"http://www.facebook.com/sharer.php?s=100&p[url]={url}&p[images][0]={img}&p[title]={title}&p[summary]={desc}"},"facebook-feed":{url:"https://www.facebook.com/dialog/feed?app_id={app_id}&link={url}&picture={img}&name={title}&description={desc}&redirect_uri={redirect_url}"},"facebook-likebox":{url:"//www.facebook.com/plugins/like.php?href={url}&colorscheme={scheme}&layout={layout}&action={action}&show_faces=false&send=false&appId=&locale={locale}"},twitter:{url:"https://twitter.com/share?url={url}&text={title}&via={via}&hashtags={hashtags}"},"twitter-follow":{url:"https://twitter.com/intent/user?screen_name={name}"},google:{url:"https://plus.google.com/share?url={url}"},pinterest:{url:"https://pinterest.com/pin/create/bookmarklet/?media={img}&url={url}&is_video={is_video}&description={title}"},linkedin:{url:"http://www.linkedin.com/shareArticle?url={url}&title={title}"},buffer:{url:"http://bufferapp.com/add?text={title}&url={url}"},digg:{url:"http://digg.com/submit?url={url}&title={title}"},tumblr:{url:"http://www.tumblr.com/share/link?url={url}&name={title}&description={desc}"},reddit:{url:"http://reddit.com/submit?url={url}&title={title}"},stumbleupon:{url:"http://www.stumbleupon.com/submit?url={url}&title={title}"},delicious:{url:"https://delicious.com/save?v=5&provider={provider}&noui&jump=close&url={url}&title={title}"}};this.defaults={popupWidth:600,popupHeight:300},this.$get=["$window","$location",function(b,e){var f={defaults:angular.extend({url:e.absUrl()},c.defaults),getUrl:function(b,c){var e=d[b];if(!e)throw"Unknown template "+b;return c=angular.extend({},e.defaults||{},this.defaults||{},c||{}),a(e.url,c)},openPopup:function(c,e){var f=d[c];if(!f)throw"Unknown template "+c;e=angular.extend({},f.defaults||{},this.defaults||{},e||{});var g=e.popupWidth||800,h=e.popupHeight||500,i=Math.floor(((screen.availWidth||1024)-g)/2),j=Math.floor(((screen.availHeight||700)-h)/2),k=a(f.url,e),l=b.open(k,"social","width="+g+",height="+h+",left="+i+",top="+j+",location=0,menubar=0,toolbar=0,status=0,scrollbars=1,resizable=1");return l&&l.focus(),!!l}};return f}]}).directive("sharePopup",["ShareUrls",function(a){return{restrict:"A",link:function(b,c,d){c.on("click",function(c){a.openPopup(d.sharePopup,d.shareOptions?b.$eval(d.shareOptions):{}),c.preventDefault()})}}}]),PIXI.ColorMatrixFilter2=function(){PIXI.AbstractFilter.call(this),this.passes=[this],this.uniforms={matrix:{type:"mat4",value:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},shift:{type:"4fv",value:[0,0,0,0]}},this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float invert;","uniform mat4 matrix;","uniform vec4 shift;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * matrix + shift;","}"]},PIXI.ColorMatrixFilter2.prototype=Object.create(PIXI.AbstractFilter.prototype),PIXI.ColorMatrixFilter2.prototype.constructor=PIXI.ColorMatrixFilter2,Object.defineProperty(PIXI.ColorMatrixFilter2.prototype,"matrix",{get:function(){return this.uniforms.matrix.value},set:function(a){this.uniforms.matrix.value=a}}),Object.defineProperty(PIXI.ColorMatrixFilter2.prototype,"shift",{get:function(){return this.uniforms.shift.value},set:function(a){this.uniforms.shift.value=a}}),PIXI.DepthmapFilter=function(a){PIXI.AbstractFilter.call(this),this.passes=[this],this.uniforms={displacementMap:{type:"sampler2D",value:a},scale:{type:"2f",value:{x:.015,y:.015}},offset:{type:"2f",value:{x:0,y:0}},mapDimensions:{type:"2f",value:{x:1,y:5112}},dimensions:{type:"4fv",value:[0,0,0,0]},focus:{type:"1f",value:.5}},a.baseTexture.hasLoaded?(this.uniforms.mapDimensions.value.x=a.width,this.uniforms.mapDimensions.value.y=a.height):(this.boundLoadedFunction=this.onTextureLoaded.bind(this),a.baseTexture.on("loaded",this.boundLoadedFunction)),this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D displacementMap;","uniform sampler2D uSampler;","uniform vec2 scale;","uniform vec2 offset;","uniform vec4 dimensions;","uniform vec2 mapDimensions;","uniform float focus;","void main(void) {","   vec2 mapCords = vTextureCoord;","   mapCords.y *= -1.0;","   mapCords.y += 1.0;","   float map = texture2D(displacementMap, mapCords).r;","   map = map * -1.0 + focus;","   vec2 disCords = vTextureCoord;","   disCords += offset * vec2(1.0, -1.0) * map * scale;","   gl_FragColor = texture2D(uSampler, disCords) * vColor;","}"]},PIXI.DepthmapFilter.prototype=Object.create(PIXI.AbstractFilter.prototype),PIXI.DepthmapFilter.prototype.constructor=PIXI.DepthmapFilter,PIXI.DepthmapFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.displacementMap.value.width,this.uniforms.mapDimensions.value.y=this.uniforms.displacementMap.value.height,this.uniforms.displacementMap.value.baseTexture.off("loaded",this.boundLoadedFunction)},Object.defineProperty(PIXI.DepthmapFilter.prototype,"map",{get:function(){return this.uniforms.displacementMap.value},set:function(a){this.uniforms.displacementMap.value=a}}),Object.defineProperty(PIXI.DepthmapFilter.prototype,"scale",{get:function(){return this.uniforms.scale.value},set:function(a){this.uniforms.scale.value=a}}),Object.defineProperty(PIXI.DepthmapFilter.prototype,"focus",{get:function(){return this.uniforms.focus.value},set:function(a){this.uniforms.focus.value=Math.min(1,Math.max(0,a))}}),Object.defineProperty(PIXI.DepthmapFilter.prototype,"offset",{get:function(){return this.uniforms.offset.value},set:function(a){this.uniforms.offset.value=a}}),angular.module("depthyApp").run(["$templateCache",function(a){a.put("views/alert-modal.html",'<div class=modal-header><h4 class=modal-title ng-click=$dismiss()><i class="icon icon-back"></i> Warning!</h4></div><div class=modal-body><p class="text-center margin-lg">{{message}}</p></div><div class=modal-footer><button class="btn btn-default" ng-click=$dismiss()>OK</button></div>'),a.put("views/alert-nodepth.html",'<div class=panel-heading><h3 class=panel-title>This image is flat as a pancake!</h3></div><div class=panel-body><p>Depthy works with photos shot using <a href="https://play.google.com/store/apps/details?id=com.google.android.GoogleCamera" target=_blank>LensBlur</a> camera mode, or created with Depthy itself.</p><div class="btn-group btn-group-unjustified"><div class="btn btn-default" ng-click=imageInfo()>Load your depthmap</div><div class="btn btn-default" ng-click=selectFile($event)>Try another</div></div><div class="alert alert-warning alert-icon" ng-if=Modernizr.android><i class="icon icon-warning"></i> Google Photos strips out the depthmap. Select <code>Documents</code> when prompted and find your LensBlur photo on your device.</div></div>'),a.put("views/alert-noimage.html",'<div class=panel-heading><h3 class=panel-title>{{depthy.getLoadError() || \'No image!\'}}</h3></div><div class=panel-body><p>Sorry, this image could not be loaded.</p><div class="btn-group btn-group-justified"><div class="btn btn-default" ng-click=selectFile($event)>Try another</div><div class="btn btn-default" ng-click=depthy.leftpaneOpen()>Open the gallery</div></div></div>'),a.put("views/alert-webgl.html","<div class=panel-heading><h3 class=panel-title>So sad!</h3></div><div class=panel-body><p>Sorry, <b>Depthy</b> works only on browsers supporting <b>WebGL</b>.</p><p ng-if=Modernizr.ios>Unfortunately, there's no official support on iOS. It should work on your Mac / PC / Android though.</p><p ng-if=Modernizr.android>It's strange, because it should work on Android. Check the latest <b>Chrome</b>, <b>Firefox</b> or <b>Opera</b>. Built-in browsers may not be fully supported.</p></div>"),a.put("views/export-modal.html",'<div class=modal-header><h4 class=modal-title ng-click=$dismiss()><i class="icon icon-back"></i> {{imageReady ? \'Your GIF is ready to take!\' : \'Please wait...\'}}</h4></div><div class=modal-body><div class="export-progress margin-xl anim-expand long" ng-hide=imageReady><div class="progress progress-md progress-striped active"><div class=progress-bar role=progressbar ng-style="{width: exportProgress * 100 + \'%\'}"></div></div><div class="alert alert-warning alert-icon" ng-if="Modernizr.mobile ? (depthy.exportSize > 150 || viewer.animateDuration > 1) : (depthy.exportSize > 300 || viewer.animateDuration > 2)"><i class="icon icon-stopwatch"></i> Generating GIFs is a tedious task. If it takes too long, choose a smaller size or make it shorter...</div></div><div class="text-center export-image anim-expand verylong ng-hide" ng-show=imageReady><div class="thumbnail center-block"><a image-source=export-gif target=_blank download="{{depthy.opened.getFilename() + \'.gif\'}}"><img image-source=export-gif></a><h5>{{imageSize / 1024 | number: 0}}KB</h5></div><p class=text-muted>{{depthy.downloadInstructions}} to save it.</p><div class="alert alert-warning alert-icon text-left" ng-if="Modernizr.android && Modernizr.chrome && !Modernizr.adownload && imageSize > 1000000"><i class="icon icon-warning"></i> Due to the bug in Chrome the option to save the GIF can be unavailable. You\'ll have to make it smaller or share it.</div><div class="alert alert-warning alert-icon text-left" ng-if=imageOverLimit><i class="icon icon-meter"></i> It\'s <b>too big</b> too share! You\'ll have to share it on your own, or make it smaller...</div><div class=margin-top-lg ng-if=!imageOverLimit><div ng-switch=shareUrl class=export-share><div class="anim-expand long" ng-switch-when=""><button class="btn btn-success btn-lg col-sm-6 col-xs-8 center-block margin-bottom-lg" ng-click=share()><i class="icon icon-upload"></i>Share it!</button><div class="alert alert-danger alert-icon text-left anim-expand" ng-if=shareError><i class="icon icon-error"></i> {{shareError}}</div><div class="alert alert-info alert-icon text-left" class=anim-expand><i class="icon icon-cloud"></i> Your GIF will be uploaded to <a href=http://imgur.com target=_blank>Imgur.com</a>.<br>It will remain relatively private until you share it too much and it goes viral.</div></div><div class="margin-xl anim-expand" ng-switch-when=sharing><div class="progress progress-md progress-striped active"><div class=progress-bar role=progressbar ng-style="{width: shareProgress * 100 + \'%\'}"></div></div><p class=text-muted>Uploading, please wait...</p></div><div class=anim-expand ng-switch-default=""><div class="alert alert-success alert-lg alert-icon"><i class="icon icon-link"></i> <a href={{shareUrl}} target=_blank>{{shareUrl}}</a></div><div class="btn-group btn-group-shares margin-lg"><div class="btn btn-icon btn-twitter" share-popup=twitter share-options=share ga="[\'send\', \'event\', \'png\', \'share\', \'twitter\']"><i class="icon icon-lg icon-twitter"></i></div><div class="btn btn-icon btn-facebook" share-popup=facebook share-options=share ga="[\'send\', \'event\', \'png\', \'share\', \'facebook\']"><i class="icon icon-lg icon-facebook"></i></div><div class="btn btn-icon btn-google" share-popup=google share-options=share ga="[\'send\', \'event\', \'png\', \'share\', \'google\']"><i class="icon icon-lg icon-googleplus"></i></div></div></div></div></div><div class="alert alert-info alert-icon text-left"><i class="icon icon-heart"></i> Want some good karma? Use <b class=text-success>#depthy</b> in your shares, thanks!</div></div></div><div class=modal-footer><button class="btn btn-default" ng-click=$dismiss()>Close</button></div>'),a.put("views/export-png-modal.html",'<div class=modal-header><h4 class=modal-title ng-click=$dismiss()><i class="icon icon-back"></i>Image saver</h4></div><div class=modal-body><div class=text-center><div class=thumbnail ng-class="{loading: loading}"><a image-source=export-png-modal target=_blank download="{{depthy.opened.getFilename() + \'.png\'}}"><img image-source=export-png-modal></a></div></div><p class="text-muted text-center">{{depthy.downloadInstructions}} to save it.</p><div class="alert alert-info alert-icon margin-top-xl"><i class="icon icon-info"></i> You can edit this image and open it later in <b>Depthy</b> to see the effects.<br></div><div class="alert alert-info alert-icon"><i class="icon icon-stack"></i> Keep in mind that less transparent spots are closer to the screen. Check the samples for reference.</div></div><div class=modal-footer><button class="btn btn-default" ng-click=$dismiss()>Close</button></div>'),a.put("views/export-popup.html",'<div class=popup-header>How do you want your GIF?</div><div class="popup-content scrollable"><div class=option><div class="btn-group btn-group-justified"><div class="btn btn-default" ng-model=depthy.exportSize btn-radio=150>Small</div><div class="btn btn-default" ng-model=depthy.exportSize btn-radio=300>Standard</div><div class="btn btn-default" ng-model=depthy.exportSize btn-radio=500>Large</div></div></div><div ng-show=customize class="anim-expand long"><div class=option ng-include="\'views/options-animation.html\'"></div><div class=option ng-include="\'views/options-movement.html\'"></div></div><div ng-show=!customize class="anim-expand short"><div class="btn btn-default btn-lg btn-block" ng-model=customize btn-checkbox="">Customize</div></div></div><div class=popup-footer><div class="btn-group btn-group-unjustified"><div class="btn btn-success btn-lg long" ng-click="depthy.activePopup.resolve(); exportGifRun()">Do it!</div><div class="btn btn-default btn-lg" ng-click=depthy.activePopup.reject()>Later?</div></div></div>'),a.put("views/howto-lensblur.html",'<div class=modal-body><p class=text-center>Bla bla bla</p></div><div class=modal-footer><button class="btn btn-default" ng-click=$dismiss()>OK</button></div>'),a.put("views/image-info-modal.html",'<span fileselect=info.depthFiles><div class=modal-header><h4 class=modal-title ng-click=$dismiss()><i class="icon icon-back"></i>Image properties</h4></div><div class=modal-body><div class=text-center><div class="thumbnails-set margin-top-none"><div class=thumbnail ng-class="{empty: !depthy.hasDepthmap(), loading: loading}"><a image-source=depth target=_blank download="{{depthy.opened.getFilename() + \'-depthmap.jpg\'}}"><img image-source=depth></a> <button class="btn btn-success btn-block" ng-click=selectFile($event)><i class=icon ng-class="isDepthmapProcessing ? \'icon-loading\' : \'icon-open\'"></i>{{depthy.hasDepthmap() ? \'New\' : \'Open\' }} depthmap</button></div><div class=thumbnail ng-if=depthy.hasOriginalImage() ng-class="{loading: loading}"><a image-source=depth target=_blank download="{{depthy.opened.getFilename() + \'-alternative.jpg\'}}"><img image-source=alternative></a> <button class="btn btn-default btn-block" disabled>Original image</button></div></div></div><p class="text-muted text-center" ng-if="depthy.hasDepthmap() || depthy.hasAlternativeImage()">{{depthy.downloadInstructions}} to save it.</p><div class="alert alert-info alert-icon margin-top-xl"><i class="icon icon-info"></i><p>You can create depthmaps for any image yourself!</p></div><div class="alert alert-info alert-icon"><i class="icon icon-stack"></i><p>Keep in mind that darker spots are closer to the screen. Check the samples for reference.</p></div></div><div class=modal-footer><button class="btn btn-default" ng-click=$dismiss()>Close</button></div></span>'),a.put("views/main.html","<div id=main ng-controller=MainCtrl ng-class=\"{\r\n    'leftpane-opened': depthy.isLeftpaneOpened() === true, \r\n    'leftpane-gallery': depthy.isLeftpaneOpened() === 'gallery', \r\n    'zen-mode': depthy.zenMode,\r\n    'offline': depthy.isOffline(),\r\n    'depthy-ready': depthy.isReady(),\r\n"+'    \'depthy-loading\': depthy.isLoading()}" ng-swipe-right=depthy.leftpaneOpen() ng-swipe-left=depthy.leftpaneClose()><div id=hamburger class="icon icon-navicon-bold" ng-click=depthy.leftpaneToggle()></div><nav id=navbar class=text-right><div class=btn-group><button class="btn btn-default btn-control" ng-click=screenfull.toggle() ng-if="screenfull.enabled && !screenfull.isFullscreen" title=Fullscreen ga=""><i class="icon icon-expand"></i></button></div></nav><div id=leftpane><div class=scroll><section id=about><header><div class=logo ng-include="\'images/logo.svg\'" ng-click=depthy.leftpaneClose()></div><p class=lead>the third dimension viewer</p></header><article class=text-center><div class="button-open btn btn-lg btn-success center-block" ng-click=selectFile($event)><i class=icon ng-class="depthy.isLoading() ? \'icon-loading\' : \'icon-open\'"></i>Open photo</div></article></section><section class="alert alert-warning alert-icon anim-expand" ng-if=depthy.isOffline()><i class="icon icon-powercord"></i> You\'re working offline.<br>Some feature may not be available!</section><section class="alert alert-success alert-icon alert-button anim-expand" ng-if=depthy.gotUpdate><i class="icon icon-loop"></i><div class="btn btn-success btn-sm pull-right" ng-click=depthy.reload()>Reload</div><div class=alert-body>There is a new version available!</div></section><section id=gallery><ul><li ng-repeat="image in depthy.gallery" ng-style="{\'background-image\':\'url(\'+image.thumb+\')\'}" ng-click=openImage(image) ng-class="\'type-\' + image.getType()" ng-if=image.isAvailable()></li></ul></section><section class=text-center id=share><div class="btn-group btn-group-shares btn-group-justified"><div class="btn btn-icon btn-twitter" share-popup=twitter share-options=depthy.share ga="[\'send\', \'event\', \'depthy\', \'share\', \'twitter\']"><i class="icon icon-twitter"></i></div><div class="btn btn-icon btn-facebook" share-popup=facebook share-options=depthy.share ga="[\'send\', \'event\', \'depthy\', \'share\', \'facebook\']"><i class="icon icon-facebook"></i></div><div class="btn btn-icon btn-google" share-popup=google share-options=depthy.share ga="[\'send\', \'event\', \'depthy\', \'share\', \'google\']"><i class="icon icon-googleplus"></i></div></div><div class="btn-group btn-group-shares btn-group-justified"><div class="btn btn-sm btn-twitter" share-popup=twitter-follow share-options="{name: \'staminapl\'}" ga="[\'send\', \'event\', \'depthy\', \'follow\', \'twitter\']"><i class="icon icon-twitter"></i>Follow</div><a class="btn btn-sm btn-google" href=https://plus.google.com/104689068982536734877 target=_blank ga="[\'send\', \'event\', \'depthy\', \'follow\', \'google\']"><i class="icon icon-googleplus"></i>Follow</a></div></section><section id=footer>Depthy {{version}} created by <a href="http://www.stamina.pl/">Rafa≈Ç Lindemann</a>.<br>Ideas? Issues? Code? It\'s open sourced on <a href=https://github.com/panrafal/depthy>GitHub</a>!</section></div></div><section id=viewer><div class=alerts><div class="panel panel-danger" ng-include="!Modernizr.webgl ? \'views/alert-webgl.html\' : null"></div><div class="alert alert-info" ng-if="depthy.isReady() && depthy.movearoundShow" ng-click="depthy.movearoundShow = false"><p>Move your {{Modernizr.devicemotion && Modernizr.mobile ? \'device\' : \'cursor\'}} around to see the effect</p></div><div class="panel panel-danger" ng-include="(Modernizr.webgl && !depthy.isLoading() && !depthy.hasImage()) ? \'views/alert-noimage.html\' : null"></div><div class="panel panel-warning" ng-include="(Modernizr.webgl && !depthy.isLoading() && depthy.hasImage() && !depthy.hasDepthmap()) ? \'views/alert-nodepth.html\' : null"></div></div><div class=depthy-viewer depthy-viewer=depthy.viewer ng-click=depthy.zenModeToggle()><canvas></canvas><div class="icon icon-loading"></div></div><div class=buttons-options ng-show=!depthy.activePopup><div class=btn-group><button class="btn btn-default btn-control" ng-click=shareOptions() ng-disabled="!depthy.hasCompleteImage() || !depthy.isReady()" title=Share><i class="icon icon-share"></i></button> <button class="btn btn-default btn-control" ng-click=imageOptions() ng-disabled="!depthy.hasCompleteImage() || !depthy.isReady()" title=Options ga=""><i class="icon icon-settings"></i></button> <button class="btn btn-default btn-control" ng-click=imageInfo() ng-disabled="!Modernizr.webgl || !depthy.hasImage() || depthy.isLoading()" title=Info ga=""><i class="icon icon-image"></i></button></div></div></section><section id=popup><div class="popup options-popup" ng-show="depthy.activePopup.state === \'image.options\'" ng-include="\'views/options-popup.html\'"></div><div class="popup export-popup" ng-if="depthy.activePopup.state === \'export.gif.options\'" ng-include="\'views/export-popup.html\'"></div><div class="popup share-popup" ng-show="depthy.activePopup.state === \'share.options\'" ng-include="\'views/share-popup.html\'"></div></section></div>'),a.put("views/options-animation.html",'<div class=option><div class="btn-group btn-group-justified"><div class="btn btn-default" ng-model=viewer.animateDuration btn-radio=0.07 ga="">x_X</div><div class="btn btn-default" ng-model=viewer.animateDuration btn-radio=1 ga="">1s</div><div class="btn btn-default" ng-model=viewer.animateDuration btn-radio=2 ga="">2s</div><div class="btn btn-default" ng-model=viewer.animateDuration btn-radio=4 ga="">4s</div><div class="btn btn-default" ng-model=viewer.animateDuration btn-radio=6 ga="">6s</div></div></div><div class=option><div class="btn-group btn-group-justified" ng-model=viewer.animateScale bs-radio-group=""><div class="btn btn-default btn-icon" ng-model=viewer.animateScale btn-radio="{x:1, y:0}" title="Left-right movement" ga=""><i class="icon icon-loop-flat"></i></div><div class="btn btn-default btn-icon" ng-model=viewer.animateScale btn-radio="{x:1, y:0.5}" title="Wide ellipse movement" ga=""><i class="icon icon-loop-ellipse"></i></div><div class="btn btn-default btn-icon" ng-model=viewer.animateScale btn-radio="{x:1, y:1}" title="Circle movement" ga=""><i class="icon icon-loop-circle"></i></div><div class="btn btn-default btn-icon" ng-model=viewer.animateScale btn-radio="{x:0.5, y:1}" title="Narrow ellipse movement" ga=""><i class="icon icon-loop-ellipse icon-rotate-90"></i></div><div class="btn btn-default btn-icon" ng-model=viewer.animateScale btn-radio="{x:0, y:1}" title="Top-bottom movement" ga=""><i class="icon icon-loop-flat icon-rotate-90"></i></div></div></div>'),a.put("views/options-movement.html",'<div class=option><div class="btn-group btn-group-justified"><div class="btn btn-default" ng-model=viewer.depthScale btn-radio=0.5 ga="">Calm</div><div class="btn btn-default" ng-model=viewer.depthScale btn-radio=1 ga="">Normal</div><div class="btn btn-default" ng-model=viewer.depthScale btn-radio=2 ga="">Dramatic</div></div></div><div class=option><div class="btn-group btn-group-justified"><div class="btn btn-default" ng-model=viewer.depthFocus btn-radio=0.00 ga="">Near</div><div class="btn btn-default" ng-model=viewer.depthFocus btn-radio=0.50 ga="">Middle</div><div class="btn btn-default" ng-model=viewer.depthFocus btn-radio=1.00 ga="">Far</div></div></div>'),a.put("views/options-popup.html",'<div class="popup-content scrollable"><div class=option><div class="btn-group btn-group-justified"><div class="btn btn-default" ng-model=viewer.fit btn-checkbox="" btn-checkbox-true="\'cover\'" btn-checkbox-false="\'contain\'"><i class="icon icon-checkbox"></i>Expand</div><div class="btn btn-default" ng-model=viewer.animate btn-checkbox=""><i class="icon icon-checkbox"></i>Hypnotize</div><div class="btn btn-default" ng-model=depthy.useOriginalImage ng-if=depthy.hasOriginalImage() btn-checkbox=""><i class="icon icon-checkbox"></i>Sharpen</div></div></div><div ng-include="viewer.animate ? \'views/options-animation.html\' : null" class=anim-expand></div><div class=option ng-include="\'views/options-movement.html\'"></div><div class=option ng-include="\'views/options-style.html\'"></div></div><div class=popup-footer><button class="btn btn-default btn-lg btn-block" ng-click=depthy.activePopup.reject()>OK</button></div>'),a.put("views/options-style.html",""),a.put("views/share-png-modal.html",'<div class=modal-header><h4 class=modal-title ng-click=$dismiss()><i class="icon icon-back"></i>Sharing is caring!</h4></div><div class="modal-body text-center"><p class="alert alert-danger alert-icon margin-xl" ng-if=uploadError class=anim-expand><i class="icon icon-error"></i>{{uploadError}}</p><div ng-if="!share && !uploadError" class="margin-xl anim-expand long"><div class="progress progress-md progress-striped active"><div class=progress-bar role=progressbar ng-style="{width: uploadProgress * 100 + \'%\'}"></div></div><p class=text-muted>Uploading, please wait...</p></div><div ng-if=share class="anim-expand long"><p>Copy this link and use it however you want:</p><div class="alert alert-success alert-lg alert-icon"><i class="icon icon-link"></i> <a href={{share.url}}>{{share.url}}</a></div><div class="btn-group btn-group-shares margin-lg"><div class="btn btn-icon btn-twitter" share-popup=twitter share-options=share ga="[\'send\', \'event\', \'png\', \'share\', \'twitter\']"><i class="icon icon-lg icon-twitter"></i></div><div class="btn btn-icon btn-facebook" share-popup=facebook share-options=share ga="[\'send\', \'event\', \'png\', \'share\', \'facebook\']"><i class="icon icon-lg icon-facebook"></i></div><div class="btn btn-icon btn-google" share-popup=google share-options=share ga="[\'send\', \'event\', \'png\', \'share\', \'google\']"><i class="icon icon-lg icon-googleplus"></i></div></div><div class="alert alert-info alert-icon text-left"><i class="icon icon-heart"></i> Want some good karma? Use <b class=text-success>#depthy</b> in your shares, thanks!</div><div class="alert alert-info alert-icon text-left" ng-if=shareImage.storeUrl class=anim-expand><i class="icon icon-cloud"></i> This image is hosted on <a href={{shareImage.storeUrl}} target=_blank>{{shareImage.store.name || shareImage.storeUrl}}</a>.</div></div></div><div class=modal-footer><button class="btn btn-default" ng-click=$dismiss()>Close</button></div>'),a.put("views/share-popup.html",'<div class="popup-content scrollable"><button class="btn btn-primary btn-block btn-lg" ng-click=sharePngRun()>Share</button> <button class="btn btn-default btn-block btn-lg" ng-click=exportGifOptions()>Create GIF</button> <button class="btn btn-default btn-block btn-lg" ng-click=exportPngRun()>Save</button></div><div class=popup-footer><button class="btn btn-default btn-block btn-lg" ng-click=depthy.activePopup.reject()>Not now</button></div>'),a.put("bower_components/angular-ui-bootstrap/template/modal/backdrop.html",'<div class="modal-backdrop fade" ng-class="{in: animate}" ng-style="{\'z-index\': 1040 + (index && 1 || 0) + index*10}"></div>'),a.put("bower_components/angular-ui-bootstrap/template/modal/window.html","<div tabindex=-1 role=dialog class=\"modal fade\" ng-class=\"{in: animate}\" ng-style=\"{'z-index': 1050 + index*10, display: 'block'}\" ng-click=close($event)><div class=modal-dialog ng-class=\"{'modal-sm': size == 'sm', 'modal-lg': size == 'lg'}\"><div class=modal-content ng-transclude=\"\"></div></div></div>")
}]),angular.module("depthyApp").run(["$templateCache",function(a){a.put("template/modal/backdrop.html",'<div class="modal-backdrop fade" ng-class="{in: animate}" ng-style="{\'z-index\': 1040 + (index && 1 || 0) + index*10}"></div>'),a.put("template/modal/window.html","<div tabindex=-1 role=dialog class=\"modal fade\" ng-class=\"{in: animate}\" ng-style=\"{'z-index': 1050 + index*10, display: 'block'}\" ng-click=close($event)><div class=modal-dialog ng-class=\"{'modal-sm': size == 'sm', 'modal-lg': size == 'lg'}\"><div class=modal-content ng-transclude=\"\"></div></div></div>")}]),angular.module("depthyApp").run(["$templateCache",function(a){a.put("images/logo.svg",'<svg xmlns="http://www.w3.org/2000/svg" viewBox="28.8 178.8 440.5 139.8" enable-background="new 28.8 178.8 440.5 139.8"><g fill="#E5E5E4"><path d="M134.8 249.2c0 4.3-.7 8.2-2 11.7s-3.3 6.5-5.8 9.1c-2.5 2.5-5.5 4.5-8.9 5.8-3.5 1.4-7.3 2.1-11.5 2.1h-21.6v-57.5h21.5c4.2 0 8.1.7 11.5 2.1 3.5 1.4 6.5 3.3 8.9 5.9s4.4 5.6 5.8 9.1 2.1 7.4 2.1 11.7zm-8 0c0-3.5-.5-6.7-1.4-9.5-1-2.8-2.3-5.1-4.1-7.1s-3.9-3.4-6.4-4.4c-2.5-1-5.3-1.5-8.4-1.5h-13.7v44.9h13.7c3.1 0 5.9-.5 8.4-1.5s4.7-2.5 6.4-4.4 3.1-4.3 4.1-7 1.4-6 1.4-9.5z"/><path d="M185.5 220.4v6.3h-27.6v19.1h22.3v6.1h-22.3v19.6h27.6v6.3h-35.4v-57.5h35.4z"/><path d="M210 256.4v21.5h-7.7v-57.5h17c3.6 0 6.8.4 9.5 1.3 2.7.8 4.9 2 6.7 3.6 1.8 1.6 3.1 3.4 3.9 5.6.9 2.2 1.3 4.6 1.3 7.3s-.5 5.1-1.4 7.3c-.9 2.2-2.3 4.1-4.1 5.7-1.8 1.6-4 2.9-6.7 3.7-2.7.9-5.7 1.3-9.2 1.3h-9.3zm0-6.2h9.2c2.2 0 4.2-.3 5.9-.9 1.7-.6 3.1-1.4 4.3-2.5 1.1-1.1 2-2.3 2.6-3.8.6-1.5.9-3.1.9-4.9 0-3.7-1.1-6.5-3.4-8.6-2.3-2.1-5.7-3.1-10.2-3.1h-9.3v23.8z"/><path d="M294.3 220.4v6.5h-18.6v50.9h-7.8v-50.8h-18.6v-6.5h45z"/><path d="M353.8 277.9h-7.8v-26.1h-31v26.1h-7.8v-57.5h7.8v25.6h31v-25.6h7.8v57.5z"/><path d="M394.7 255v22.9h-7.7v-22.9l-21.1-34.6h6.8c.7 0 1.2.2 1.6.5.4.3.7.8 1 1.3l13.2 22.3c.5.9 1 1.8 1.3 2.6.4.8.7 1.6 1 2.4.3-.8.6-1.7 1-2.5.3-.8.8-1.7 1.3-2.6l13.1-22.3c.2-.4.6-.8 1-1.2.4-.4 1-.6 1.6-.6h6.9l-21 34.7z"/></g><path fill="#E5E5E4" d="M444 204v90h-390v-90h390m5-5h-400v100h400v-100z"/><path fill="#E6E7E8" d="M444.5 183.8v20.2h19.8v109.7h-430.5v-129.9h410.7m5-5h-420.7v139.8h440.5v-119.6h-19.8v-20.2z"/></svg>')}]),angular.module("depthyApp").controller("ExportModalCtrl",["$scope","$modalInstance","$rootElement","depthy","ga","$timeout",function(a,b,c,d,e,f){a.exportProgress=-1,a.imageReady=!1,a.shareUrl="",a.tweetUrl=null,a.imageOverLimit=!1,f(function(){var c=d.exportAnimation(),f=null,g=null,h=new Date,i="size "+d.exportSize+" dur "+d.viewer.animDuration;e("send","event","gif","start",i),c.then(function(b){e("send","timing","gif","created",new Date-h,i),e("send","event","gif","created",i,b.size),a.imageSize=b.size,a.imageOverLimit=b.size>2097152;var c=new FileReader;c.onload=function(){g=c.result;var d=URL.createObjectURL(b);angular.element('img[image-source="export-gif"]').attr("src",d),angular.element('a[image-source="export-gif"]').attr("href",d),a.imageReady=!0,a.$safeApply()},c.readAsDataURL(b)},function(){a.exportError="Export failed"},function(b){a.exportProgress=b,a.$safeApply()}),a.share=function(){e("send","event","gif","upload",i,a.imageSize),a.shareUrl="sharing",a.shareError=null,a.shareProgress=0,f=$.ajax({url:"https://api.imgur.com/3/image.json",method:"POST",headers:{Authorization:"Client-ID "+d.imgurId,Accept:"application/json"},data:{image:g.substr("data:image/gif;base64,".length),type:"base64",name:d.opened.title,title:d.opened.title+" #depthy",description:"Created using http://depthy.me"},xhr:function(){var b=new window.XMLHttpRequest;return b.upload.addEventListener("progress",function(b){b.lengthComputable&&(a.shareProgress=b.loaded/b.total,a.$safeApply())},!1),b}}).done(function(b,c,g){console.log(b,c,g);var h=b.data.id;e("send","event","gif","upload-success"),a.shareUrl="https://imgur.com/"+h,a.share={url:a.shareUrl,title:d.opened.title+" #depthy",img:"https://i.imgur.com/"+h+".gif"},f=null,a.$safeApply()}).fail(function(b,c){var d=b.responseJSON||{};f=null,a.shareUrl="",a.shareError=(d.data||{}).error||"Something went wrong... Please try again.",console.error("Share failed with ",d),e("send","event","gif","upload-error",c+": "+a.shareError),a.$safeApply()})},b.result.finally(function(){console.log("close"),c&&c.abort(),f&&f.abort(),a.imageUrl&&URL.revokeObjectURL(a.imageUrl)})},d.modalWait)}]),angular.module("depthyApp").controller("ImageInfoModalCtrl",["$scope","$modalInstance","ga","depthy","$timeout","StateModal",function(a,b,c,d,e,f){a.info={},a.loading=2,e(function(){if(d.hasDepthmap()?d.getViewer().exportDepthmap().then(function(b){var c=angular.element('img[image-source="depth"]')[0];c.onload=function(){--a.loading,a.$safeApply()},c.src=b,angular.element('a[image-source="depth"]').attr("href",b)}):--a.loading,d.hasOriginalImage()){var b=angular.element('img[image-source="alternative"]')[0];b.onload=function(){--a.loading,a.$safeApply()},b.src=d.opened.originalSource,angular.element('a[image-source="alternative"]').attr("href",d.opened.originalSource)}else--a.loading},d.modalWait),a.isDepthmapProcessing=!1,a.$watch("info.depthFiles",function(e){e&&e.length&&(a.isDepthmapProcessing=!0,d.loadLocalDepthmap(e[0]).then(function(d){a.isDepthmapProcessing=!1,c("send","event","depthmap","parsed",d?"from-lensblur":"from-file"),b.dismiss()},function(b){a.isDepthmapProcessing=!1,c("send","event","depthmap","error",b),f.showAlert(b,{stateOptions:{location:"replace"}})}))})}]),angular.module("depthyApp").controller("SharePngModalCtrl",["$scope","$sce","$timeout","$modalInstance","$state","$q","ga","depthy",function(a,b,c,d,e,f,g,h){function i(b){g("send","event","png","upload","",b.length),k=$.ajax({url:"https://api.imgur.com/3/image.json",method:"POST",headers:{Authorization:"Client-ID "+h.imgurId,Accept:"application/json"},data:{image:b.substr("data:image/png;base64,".length),type:"base64",name:a.image.title,title:a.image.title+" #depthy",description:"View this image in 3D on http://depthy.me"},xhr:function(){var b=new window.XMLHttpRequest;return b.upload.addEventListener("progress",function(b){b.lengthComputable&&(a.uploadProgress=b.loaded/b.total,a.$safeApply())},!1),b}}).done(function(b,c,d){console.log(b,c,d);var e=b.data.id,f=b.data.deletehash;"image/png"===b.data.type?(g("send","event","png","upload-success"),a.shareImage=a.image.createShareImage({url:"https://i.imgur.com/"+e,state:"imgur",stateParams:{id:e},thumb:"https://i.imgur.com/"+e+"s.jpg",store:h.stores.imgur,storeUrl:"https://imgur.com/"+e,storeKey:f}),a.share=a.image.getShareInfo(),k=null,$.ajax({url:"https://api.imgur.com/3/image/"+f,method:"POST",headers:{Authorization:"Client-ID "+h.imgurId,Accept:"application/json"},data:{description:"View this image in 3D on "+a.share.url}})):(a.uploadError="This file is too big to upload it to imgur... Sorry :(",g("send","event","png","upload-converted"),$.ajax({url:"https://api.imgur.com/3/image/"+f,method:"DELETE",headers:{Authorization:"Client-ID "+h.imgurId,Accept:"application/json"}})),a.$safeApply()}).fail(function(b,c){var d=b.responseJSON||{};k=null,a.uploadError=(d.data||{}).error||"Something went wrong... Please try again.",console.error("Share failed with ",d),g("send","event","png","upload-error",c+": "+a.uploadError),a.$safeApply()})}function j(b,c,d){b=Math.round(b),console.group("Trying PNG size "+b),h.getViewer().exportToPNG({width:b,height:b}).then(function(e){console.log("PNG size: ",e.length),console.groupEnd(),e.length>d?b>500?j(b*c,c,d):a.uploadError="This file is too big to upload it to imgur... Sorry :(":i(e)})}var k;a.image=h.opened,a.shareImage=h.opened,a.share=a.image.getShareInfo(),a.share||c(function(){j(850,.8,95e4)},h.modalWait),d.result.finally(function(){console.log("close"),k&&k.abort()})}]),angular.module("depthyApp").controller("ExportPngModalCtrl",["$scope","$sce","$timeout","depthy",function(a,b,c,d){a.loading=!0,c(function(){d.getViewer().exportToPNG(null).then(function(b){b=URL.createObjectURL(d.dataURItoBlob(b));var c=angular.element('img[image-source="export-png-modal"]')[0];c.onload=function(){a.loading=!1,a.$safeApply()},c.src=b,angular.element('a[image-source="export-png-modal"]').attr("href",b)})},d.modalWait)}]),function(a){var b=a.$&&a.$.extend||a._&&a._.extend||a.angular&&a.angular.extend,c=a.$&&a.$.isNumeric||a._&&a._.isNumber||a.angular&&a.angular.isNumber,d=function(){return a.Modernizr&&a.Modernizr.isMobile},e=a.Q&&a.Q.Promise||a.RSVP&&a.RSVP.Promise||a.Promise,f={size:null,fit:"contain",retina:!0,upscale:1,animate:!1,animateDuration:2,animatePosition:null,animateScale:{x:1,y:.5},depthScale:1,depthBlurSize:16,depthFocus:.5,easeFactor:d()?.2:.4,orient:!0,hover:!0,hoverElement:!1},g=a.DepthyViewer=function(a,g){function h(){N=a.getElementsByTagName("canvas")[0],N||(N=a.ownerDocument.createElement("canvas"),a.appendChild(N)),i(),k(),n(),P&&requestAnimFrame(M)}function i(){var b=g.hoverElement||a;return"string"==typeof b&&(b=a.ownerDocument.querySelector(b)),b?(b.addEventListener("mousemove",j,!1),void b.addEventListener("touchmove",j,!1)):void console.warn("Hover element %s not found!",g.hoverElement)}function j(a){if(!g.animate&&g.hover&&V&&x()){var b=a.currentTarget,c=.9*Math.min(W.height,W.width),d=a.touches?a.touches[0]:a,e=(d.pageX-b.offsetLeft)/b.offsetWidth,f=(d.pageY-b.offsetTop)/b.offsetHeight;e=Math.max(-1,Math.min(1,(2*e-1)*b.offsetWidth/c)),f=Math.max(-1,Math.min(1,(2*f-1)*b.offsetHeight/c)),jb={x:-e,y:-f},ib=!0}}function k(){window.DeviceMotionEvent?window.addEventListener("devicemotion",m):window.DeviceOrientationEvent?(console.warn("devicemotion unsupported!"),window.addEventListener("deviceorientation",l)):console.warn("deviceorientation unsupported!")}function l(a){if(!g.animate&&g.orient&&x()&&null!==a.beta&&null!==a.gamma){if(lb){var b=window.innerHeight>window.innerWidth,c=.2*(a.beta-lb.beta),d=.2*(a.gamma-lb.gamma),e=b?-d:-c,f=b?-c:-d;e&&f&&(jb={x:Math.max(-1,Math.min(1,jb.x+e)),y:Math.max(-1,Math.min(1,jb.y+f))},ib=!0)}lb={alpha:a.alpha,beta:a.beta,gamma:a.gamma}}}function m(a){var b=a.rotationRate,c=a.accelerationIncludingGravity||{};if(!b)return console.warn("devicemotion seems to be unsupported :(",a,b),window.removeEventListener("devicemotion",m),void window.addEventListener("deviceorientation",l);if(!g.animate&&g.orient&&x()){var d=Modernizr.chrome&&!Modernizr.ios?1:.005,e=window.innerHeight>window.innerWidth,f=(e?b.beta:b.alpha)*-d,h=(e?b.alpha:-b.beta)*-d;Math.abs(c.z)<9&&(e?c.y:c.x)<0&&(f*=-1,h*=-1),f&&h&&(jb={x:Math.max(-1,Math.min(1,jb.x+f)),y:Math.max(-1,Math.min(1,jb.y+h))},ib=!0)}}function n(){O=new PIXI.Stage;try{P=new PIXI.WebGLRenderer(800,600,N,!1,!0),R=o(),S=q(),T=r(),U=s()}catch(a){console.error("WebGL failed",a),P=!1,Modernizr&&(Modernizr.webgl=!1)}}function o(){var a=new PIXI.ColorMatrixFilter2;return a.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],a.shift=[0,0,0,0],a}function p(){var a=new PIXI.ColorMatrixFilter2;return a.matrix=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],a.shift=[0,0,0,0],a}function q(){var a=new PIXI.ColorMatrixFilter2;return a.matrix=[0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,0],a.shift=[1,1,1,1],a}function r(){var a=new PIXI.ColorMatrixFilter2;return a.matrix=[0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0],a.shift=[0,0,0,1],a}function s(){return new PIXI.BlurFilter}function t(a,b){return b=b||1,{width:a.width*b,height:a.height*b}}function u(a,b,c){var d=a.width/a.height;return a=t(a),(c&&a.height<b.height||!c&&a.height>b.height)&&(a.height=b.height,a.width=a.height*d),(c&&a.width<b.width||!c&&a.width>b.width)&&(a.width=b.width,a.height=a.width/d),a}function v(a){return{width:Math.round(a.width),height:Math.round(a.height)}}function w(a,b,c){return c?b.width/b.height>a.width/a.height?b.width/a.width:b.height/a.height:b.width/b.height>a.width/a.height?b.height/a.height:b.width/a.width}function x(){return!(P===!1||!eb.texture||!eb.size||fb.texture&&!fb.size)}function y(){return eb.texture&&fb.texture&&eb.texture===fb.texture}function z(){return!!eb.texture}function A(){return!!fb.texture}function B(a,b){if(a.url===b)return a;var c={dirty:!0};return c.promise=new e(function(d,e){b?(c.url=b,c.texture=PIXI.Texture.fromImage(b),c.texture.baseTexture.premultipliedAlpha=!1,c.texture.baseTexture.hasLoaded?(c.size=c.texture.frame,gb=!0,d(c)):(c.texture.addEventListener("update",function(){c.texture&&(c.size=c.texture.frame,gb=!0,d(c))}),c.texture.baseTexture.source.onerror=function(a){c.texture&&(console.error("Texture load failed",a),c.error=!0,c.texture.destroy(!0),delete c.texture,e(a))})):(console.log("Empty texture!"),d(c)),a&&(a.texture&&!y()&&a.texture.destroy(!0),a.texture=null)}),c}function C(){var a=t(eb.size,g.fit&&g.upscale||1);V=t(a),g.size&&(V=u(V,g.size),"cover"===g.fit&&(V=u(V,g.size,!0),V=u(V,a),V.height>g.size.height&&(V.height=g.size.height),V.width>g.size.width&&(V.width=g.size.width))),W=v(V),g.retina&&g.fit&&window.devicePixelRatio>=2&&(V.width*=2,V.height*=2),V=u(V,eb.size),V=v(V),N.style.width=W.width+"px",N.style.height=W.height+"px",N.style.marginLeft=Math.round(W.width/-2)+"px",N.style.marginTop=Math.round(W.height/-2)+"px",!P||P.width===V.width&&P.height===V.height||(P.resize(V.width,V.height),eb.dirty=fb.dirty=!0,hb=!0),gb=!1}function D(){var a=w(eb.size,V,!0);Y=new PIXI.Sprite(eb.texture),Y.scale=new PIXI.Point(a,a),Y.anchor={x:.5,y:.5},Y.position={x:V.width/2,y:V.height/2},Y.filters=[R],Z=new PIXI.DisplayObjectContainer,Z.addChild(Y),!$||$.width===V.width&&$.height===V.height||($.destroy(!0),$=null),$=$||new PIXI.RenderTexture(V.width,V.height),eb.dirty=!1,eb.renderDirty=hb=!0}function E(){$.render(Z,null,!0),eb.renderDirty=!1}function F(){var a=fb.size?w(fb.size,V,!0):1;ab=new PIXI.DisplayObjectContainer,A()?(_=new PIXI.Sprite(fb.texture),_.filters=[U],_.scale=new PIXI.Point(a,a),_.renderable=!!fb.texture,_.anchor={x:.5,y:.5},_.position={x:V.width/2,y:V.height/2},fb.useAlpha&&(_.filters.push(S),_.filters=_.filters),ab.addChild(_)):_=null,!bb||bb.width===V.width&&bb.height===V.height||(bb.destroy(!0),bb=null),bb=bb||new PIXI.RenderTexture(V.width,V.height),fb.dirty=!1,fb.renderDirty=hb=!0}function G(){U.blur=g.depthBlurSize,bb.render(ab),fb.renderDirty=!1}function H(){cb=new PIXI.DepthmapFilter(bb),db&&O.removeChild(db),db=new PIXI.Sprite($),db.filters=[cb],O.addChild(db),hb=!1,ib=Q=!0}function I(){var a=(d()?.015:.015)*(g.depthScale||1);cb.scale={x:(V.width>V.height?1:V.height/V.width)*a,y:(V.width<V.height?1:V.width/V.height)*a},cb.offset={x:kb.x||0,y:kb.y||0},cb.focus=g.depthFocus,Q=!1,ib=!0}function J(){(jb.x!==kb.x||jb.y!==kb.y)&&(g.easeFactor&&!g.animate?(kb.x=kb.x*g.easeFactor+jb.x*(1-g.easeFactor),kb.y=kb.y*g.easeFactor+jb.y*(1-g.easeFactor),Math.abs(kb.x-jb.x)<1e-4&&Math.abs(kb.y-jb.y)<1e-4&&(kb=jb)):kb=jb,cb.offset={x:kb.x,y:kb.y},ib=!0)}function K(){if(g.animate){var a=c(g.animatePosition)?g.animatePosition*g.animateDuration*1e3:window.performance&&window.performance.now?window.performance.now():(new Date).getTime();cb.offset={x:Math.sin(a*Math.PI*2/g.animateDuration/1e3)*g.animateScale.x,y:Math.cos(a*Math.PI*2/g.animateDuration/1e3)*g.animateScale.y},ib=!0}}function L(){x()&&(gb&&C(),eb.dirty&&D(),eb.renderDirty&&E(),fb.dirty&&F(),fb.renderDirty&&G(),hb&&H(),Q&&I(),A()&&(J(),K()),X&&(X(),X=null),ib&&(P.render(O),ib=!1))}function M(){L(),requestAnimFrame(M)}var N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb={},fb={},gb=!0,hb=!0,ib=!0,jb={x:0,y:0},kb=jb;g=b({},f,g||{});var lb;this.setOptions=function(a){for(var b in a)if(g[b]!==a[b])switch(g[b]=a[b],b){case"size":case"fit":case"retina":case"upscale":gb=!0;break;case"depthScale":case"depthFocus":Q=!0;break;case"depthBlurSize":fb.renderDirty=!0;break;default:ib=!0}},this.getOptions=function(){return g},this.getElement=function(){return a},this.getCanvas=function(){return N},this.getSize=function(){return t(V)},this.getSizeCPX=function(){return t(W)},this.getPromise=function(a){if(!a&&(!this.hasImage()||this.getLoadError()))return e.reject();if(x())return e.resolve();if(!X){var b=new e(function(a){X=a});X.promise=b}return a?X.promise:e.all([eb.promise,fb.promise,X.promise])},this.setImage=function(a){return eb=B(eb,a),eb.promise},this.setDepthmap=function(a,b){return fb=B(fb,a),fb.useAlpha=!!b,fb.promise},this.render=L,this.reset=function(){this.setImage(),this.setDepthmap()},this.hasImage=z,this.hasDepthmap=A,this.getLoadError=function(){return eb.error||fb.error},this.setOffset=function(a){jb=a},this.exportToPNG=function(a){return this.getPromise().then(function(){if(!A())return!1;var b=v(u(eb.size,a||eb.size)),c=new PIXI.Stage,d=b.width/eb.size.width,e=new PIXI.WebGLRenderer(b.width,b.height,null,"notMultiplied",!0),f=new PIXI.Sprite(eb.texture);f.scale=new PIXI.Point(d,d),c.addChild(f),f.filters=[o()];var g=new PIXI.Sprite(fb.texture);g.scale=new PIXI.Point(d,d),g.filters=[fb.useAlpha?p():r()],PIXI.blendModesWebGL["one.one"]=[e.gl.ONE,e.gl.ONE],g.blendMode="one.one",c.addChild(g),e.render(c);var h=e.view.toDataURL("image/png");try{e.destroy()}catch(i){console.error("Render destroy error",i)}return h})},this.exportDepthmap=function(){return this.getPromise().then(function(){if(A()){if(!fb.useAlpha&&fb.url)return fb.url;var a=new PIXI.Stage,b=new PIXI.WebGLRenderer(fb.size.width,fb.size.height,null,!1,!0),c=new PIXI.Sprite(fb.texture);fb.useAlpha&&(c.filters=[q()]),a.addChild(c),b.render(a);var d=b.view.toDataURL("image/jpeg");try{b.destroy()}catch(e){console.error("Render destroy error",e)}return d}return!1})},this.exportThumbnail=function(a,b){return a=a||{width:50,height:50},this.getPromise().then(function(){var c=new PIXI.Stage,d=w(eb.size,a,!0),e=new PIXI.WebGLRenderer(a.width,a.height,null,!1,!0),f=new PIXI.Sprite(eb.texture);f.scale=new PIXI.Point(d,d),f.anchor={x:.5,y:.5},f.position={x:a.width/2,y:a.height/2},c.addChild(f),f.filters=[o()],e.render(c);var g=e.view.toDataURL("image/jpeg",b);try{e.destroy()}catch(h){console.error("Render destroy error",h)}return g})},this.isReady=x,h()};g.defaultOptions=f}(window),angular.module("depthyApp").service("StateModal",["$rootScope","$modal","$state","$location","$window","$q",function(a,b,c,d,e,f){this.stateDeferred=function(b,g){g=g||{};var h,i=f.defer();return i.state=b,b&&!g.stateCurrent&&b!==!0&&c.go(b,g.stateParams,g.stateOptions),i.promise.then(function(){h&&h(),b&&c.current.name===b&&d.replace()},function(){h&&h(),b&&c.current.name===b&&e.history.back()}),b&&(h=a.$on("$stateChangeStart",function(a,c,d,e){h(),h=null,(b===!0||e.name===b)&&(b=!1,i.reject())})),i},this.showModal=function(a,c){var d,e=this.stateDeferred(a,c);return d=b.open(c||{}),d.result.then(function(){e.resolve()},function(){e.reject()}),e.promise.finally(function(){d.close()}),d},this.showAlert=function(b,c,d){return this.showModal(d||"alert",angular.extend({templateUrl:"views/alert-modal.html",windowClass:"alert-modal",scope:angular.extend(a.$new(),{message:b})},c||{}))}}]),angular.module("depthyApp").service("UpdateCheck",["$window","$q",function(a,b){this.check=function(c){var d=a.applicationCache;if(!d)return b.reject();var e=b.defer();return a.addEventListener("load",function(){c&&d.status===d.IDLE&&(console.log("Updating the app cache!"),d.update()),d.addEventListener("updateready",function(){d.status===window.applicationCache.UPDATEREADY?(console.log("Got update!"),e.resolve(!0)):e.resolve(!1)},!1),d.addEventListener("noupdate",function(){e.resolve(!1)},!1)},!1),e.promise}}]);